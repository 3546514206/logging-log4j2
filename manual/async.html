<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Asynchronous loggers :: Apache Log4j</title>
    <link rel="canonical" href="https://logging.apache.org/log4j/3.x/manual/async.html">
    <meta name="generator" content="Antora 3.2.0-alpha.4">
<link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/../_images/favicon.ico" type="image/x-icon">
<!-- `@asciidoctor/tabs` extension styles -->
<link rel="stylesheet" href="../_/css/vendor/tabs.css">
<style>
  /* Default `h4` and `h5` are smaller than the normal text, fix header font sizing: */
  .doc h1 { font-size: 1.9rem; }
  .doc h2 { font-size: 1.7rem; }
  .doc h3 { font-size: 1.5rem; font-weight: 400; }
  .doc h4 { font-size: 1.3rem; font-weight: 500; }
  .doc h5 { font-size: 1.1rem; font-weight: 500; text-decoration: underline; }
  /* Default `code`, `pre`, and `.colist` (source code annotations) fonts are too big, adjust them: */
  .doc .colist>table code, .doc p code, .doc thead code { font-size: 0.8em; }
  .doc pre { font-size: 0.7rem; }
  .doc .colist { font-size: 0.75rem; }
  /* Make links more visible: */
  .doc a { text-decoration: underline; }
  .doc a code { text-decoration: underline; color: #1565c0; }
  /* Tab header fonts aren't rendered good, adjusting the font weight: */
  .tablist > ul li { font-weight: 500; }
  /* `page-toclevels` greater than 4 are not supported by Antora UI, patching it: */
  .toc .toc-menu li[data-level="4"] a {
    padding-left: 2.75rem;
  }
  /* Replace the default highlight.js color for strings from red (unnecessarily signaling something negative) to green: */
  .hljs-string {
    color: #0f8532;
  }
</style>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <img src="../_/../_images/logo-small-white.png" alt="Apache Log4j"/>
      </div>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://logging.apache.org">a subproject of&nbsp;<strong>Apache Logging Services</strong></a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">Home</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../download.html">Download</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes.html">Release Notes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="https://logging.apache.org/support.html">Support</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://logging.apache.org/security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../thanks.html">Thanks</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Resources</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../faq.html">F.A.Q.</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="migration.html">Migrating from Log4j 2</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cloud.html">Using Log4j in Cloud Enabled Applications</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../development.html">Development</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Manual</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="installation.html">Installation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="api.html">API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration file</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="systemproperties.html">Configuration properties</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="customconfig.html">Programmatic Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="appenders.html">Appenders</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="layouts.html">Layouts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="json-template-layout.html">JSON Template Layout</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lookups.html">Lookups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="filters.html">Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scripts.html">Scripts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="jmx.html">JMX</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="extending.html">Extending</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="plugins.html">Plugins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="performance.html">Performance</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="async.html">Asynchronous loggers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="garbagefree.html">Garbage-free logging</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">References</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../plugin-reference.html">Plugin reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../javadoc.html">Java API reference</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Components</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-flume-ng.html">Flume Appender</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-iostreams.html">Log4j IOStreams</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-docker.html">Log4j Docker Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-spring-cloud-config-client.html">Log4j Spring Cloud Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Related projects</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://logging.apache.org/log4j/2.x">Log4j 2</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/jakarta">Log4j Jakarta EE</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/jmx-gui">Log4j JMX GUI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/kotlin">Log4j Kotlin</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/scala">Log4j Scala</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/tools">Log4j Tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/transform">Log4j Transformation Tools</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Home</a></li>
    <li><a href="index.html">Manual</a></li>
    <li><a href="performance.html">Performance</a></li>
    <li><a href="async.html">Asynchronous loggers</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="https://github.com/apache/logging-log4j2/edit/main/src/site/antora/modules/ROOT/pages/manual/async.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="4">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Asynchronous loggers</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Asynchronous logging can improve your application&#8217;s performance by executing the I/O operations in a separate thread.
Log4j 2 makes a number of improvements in this area.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Asynchronous Loggers</strong> are a new addition in Log4j 2. Their aim is to return from the call to Logger.log to the application as soon as possible.
You can choose between making all Loggers asynchronous or using a mixture of synchronous and asynchronous Loggers.
Making all Loggers asynchronous will give the best performance, while mixing gives you more flexibility.</p>
</li>
<li>
<p><strong>LMAX Disruptor technology</strong>.
Asynchronous Loggers internally use the
<a href="#UnderTheHood">Disruptor</a>, a lock-free inter-thread communication library, instead of queues, resulting in higher throughput and lower latency.</p>
</li>
<li>
<p>As part of the work for Async Loggers, <strong>Asynchronous Appenders</strong> have been enhanced to flush to disk at the end of a batch (when the queue is empty).
This produces the same result as configuring "immediateFlush=true", that is, all received log events are always available on disk, but is more efficient because it does not need to touch the disk on each and every log event.
(Async Appenders use ArrayBlockingQueue internally and do not need the disruptor jar on the classpath.)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Trade-offs"><a class="anchor" href="#Trade-offs"></a>Trade-offs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Although asynchronous logging can give significant performance benefits, there are situations where you may want to choose synchronous logging.
This section describes some of the trade-offs of asynchronous logging.</p>
</div>
<div class="sect2">
<h3 id="_benefits"><a class="anchor" href="#_benefits"></a>Benefits</h3>
<div class="ulist">
<ul>
<li>
<p>Higher peak performance throughput.
With an asynchronous logger your application can log messages at 6 - 68 times the rate of a synchronous logger.</p>
<div class="paragraph">
<p>This is especially interesting for applications that occasionally need to log bursts of messages.
Async logging can help prevent or dampen latency spikes by shortening the wait time until the next message can be logged.
If the queue size is configured large enough to handle the burst, asynchronous logging will help prevent your application from falling behind (as much) during a sudden increase of activity.</p>
</div>
</li>
<li>
<p>Lower logging response time <a href="#Latency">latency</a>.
Response time latency is the time it takes for a call to Logger.log to return under a given workload.
Asynchronous Loggers have consistently lower latency than synchronous loggers or even queue-based asynchronous appenders.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_drawbacks"><a class="anchor" href="#_drawbacks"></a>Drawbacks</h3>
<div class="paragraph">
<p>There are certain drawbacks associated with asynchronous logging:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Error handling</dt>
<dd>
<p>If a problem happens during the logging process and an exception is thrown, it is less easy for an asynchronous setting to signal this problem to the application.
This can partly be alleviated by configuring an exception handler, but this may still not cover all cases.</p>
</dd>
<dt class="hdlist1">Stateful messages</dt>
<dd>
<p>In some rare cases, care must be taken with mutable messages.
Most of the time you don&#8217;t need to worry about this.
Log4 will ensure that log messages like <code>logger.debug("My object is {}", myObject)</code> will use the state of the <code>myObject</code> parameter at the time of the call to <code>logger.debug()</code>.
The log message will not change even if <code>myObject</code> is modified later.
It is safe to asynchronously log mutable objects because most <a href="https://logging.apache.org/log4j/2.x/manual/messages.adoc">built-in <code>Message</code> implementations</a> take a snapshot of the parameters.
There are some exceptions however: <a href="https://logging.apache.org/log4j/2.x/manual/messages.adoc#MapMessage"><code>MapMessage</code></a> and <a href="https://logging.apache.org/log4j/2.x/manual/messages.adoc#StructuredDataMessage"><code>StructuredDataMessage</code></a> are mutable by design, fields can be added to these messages after the message object was created.
These messages should not be modified after they are logged with asynchronous loggers or asynchronous appenders; you may or may not see the modifications in the resulting log output.
Similarly, custom <code>Message</code> implementations should be designed with asynchronous use in mind, and either take a snapshot of their parameters at construction time, or document their thread-safety characteristics.</p>
</dd>
<dt class="hdlist1">Computational overhead</dt>
<dd>
<p>If your application is running in an environment where CPU resources are scarce, like a machine with one CPU with a single core, starting another thread is not likely to give better performance.</p>
</dd>
<dt class="hdlist1">Appender performance</dt>
<dd>
<p>If the sustained rate at which your application is logging messages is faster than the maximum sustained throughput of the underlying appender, the queue will fill up and the application will end up logging at the speed of the slowest appender. If this happens, consider selecting a faster appender, or logging less. If neither of these is an option, you may get better throughput and fewer latency spikes by logging synchronously.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="AllAsync"><a class="anchor" href="#AllAsync"></a>Making All Loggers Asynchronous</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Log4j-2.9 and higher require disruptor-3.3.4.jar or higher on the classpath.
Prior to Log4j-2.9, disruptor-3.0.0.jar or higher was required.</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is simplest to configure and gives the best performance.
To make all loggers asynchronous, add the disruptor jar to the classpath and set the system property <code>log4j2.contextSelector</code> to
<code>org.apache.logging.log4j.core.async.AsyncLoggerContextSelector</code> or
<code>org.apache.logging.log4j.core.async.BasicAsyncLoggerContextSelector</code>.</p>
</div>
<div class="paragraph">
<p>By default, <a href="#Location">location</a> is not passed to the I/O thread by asynchronous loggers.
If one of your layouts or custom filters needs location information, you need to set "includeLocation=true" in the configuration of all relevant loggers, including the root logger.</p>
</div>
<div class="paragraph">
<p>A configuration that does not require location might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;!-- Don't forget to set system property
-Dlog4j2.contextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector
or
-Dlog4j2.contextSelector=org.apache.logging.log4j.core.async.BasicAsyncLoggerContextSelector
     to make all loggers asynchronous. --&gt;

&lt;Configuration status="WARN"&gt;
  &lt;Appenders&gt;
    &lt;!-- Async Loggers will auto-flush in batches, so switch off immediateFlush. --&gt;
    &lt;RandomAccessFile name="RandomAccessFile" fileName="async.log" immediateFlush="false" append="false"&gt;
      &lt;PatternLayout&gt;
        &lt;Pattern&gt;%d %p %c{1.} [%t] %m %ex%n&lt;/Pattern&gt;
      &lt;/PatternLayout&gt;
    &lt;/RandomAccessFile&gt;
  &lt;/Appenders&gt;
  &lt;Loggers&gt;
    &lt;Root level="info" includeLocation="false"&gt;
      &lt;AppenderRef ref="RandomAccessFile"/&gt;
    &lt;/Root&gt;
  &lt;/Loggers&gt;
&lt;/Configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>AsyncLoggerContextSelector</code> or
<code>BasicAsyncLoggerContextSelector</code> is used to make all loggers asynchronous, make sure to use normal <code>&lt;root&gt;</code> and <code>&lt;logger&gt;</code> elements in the configuration.
The context selector will ensure that all loggers are asynchronous, using a mechanism that is different from what happens when you configure <code>&lt;asyncRoot&gt;</code> or <code>&lt;asyncLogger&gt;</code>.
The latter elements are intended for mixing async with sync loggers.
If you use both mechanisms together you will end up with two background threads, where your application passes the log message to thread A, which passes the message to thread B, which then finally logs the message to disk.
This works, but there will be an unnecessary step in the middle.</p>
</div>
<div class="paragraph">
<p>There are a few system properties you can use to control aspects of the asynchronous logging subsystem.
Some of these can be used to tune logging performance.</p>
</div>
<div class="paragraph">
<p>The below properties can also be specified by creating a file named
<code>log4j2.component.properties</code> and including this file in the classpath of the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MixedSync-Async"><a class="anchor" href="#MixedSync-Async"></a>Mixing Synchronous and Asynchronous Loggers</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Log4j-2.9 and higher require disruptor-3.3.4.jar or higher on the classpath.
Prior to Log4j-2.9, disruptor-3.0.0.jar or higher was required.
There is no need to set system property "Log4jContextSelector" to any value.</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Synchronous and asynchronous loggers can be combined in configuration.
This gives you more flexibility at the cost of a slight loss in performance (compared to making all loggers asynchronous).
Use the
<code>&lt;asyncRoot&gt;</code> or <code>&lt;asyncLogger&gt;</code> configuration elements to specify the loggers that need to be asynchronous.
A configuration can contain only one root logger (either a <code>&lt;root&gt;</code> or an <code>&lt;asyncRoot&gt;</code> element), but otherwise async and non-async loggers may be combined.
For example, a configuration file containing <code>&lt;asyncLogger&gt;</code> elements can also contain
<code>&lt;root&gt;</code> and <code>&lt;logger&gt;</code> elements for the synchronous loggers.</p>
</div>
<div class="paragraph">
<p>By default, <a href="#Location">location</a> is not passed to the I/O thread by asynchronous loggers.
If one of your layouts or custom filters needs location information, you need to set "includeLocation=true" in the configuration of all relevant loggers, including the root logger.</p>
</div>
<div class="paragraph">
<p>A configuration that mixes asynchronous loggers might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;!-- No need to set system property "log4j2.contextSelector" to any value
     when using &lt;asyncLogger&gt; or &lt;asyncRoot&gt;. --&gt;

&lt;Configuration status="WARN"&gt;
  &lt;Appenders&gt;
    &lt;!-- Async Loggers will auto-flush in batches, so switch off immediateFlush. --&gt;
    &lt;RandomAccessFile name="RandomAccessFile" fileName="asyncWithLocation.log"
              immediateFlush="false" append="false"&gt;
      &lt;PatternLayout&gt;
        &lt;Pattern&gt;%d %p %class{1.} [%t] %location %m %ex%n&lt;/Pattern&gt;
      &lt;/PatternLayout&gt;
    &lt;/RandomAccessFile&gt;
  &lt;/Appenders&gt;
  &lt;Loggers&gt;
    &lt;!-- pattern layout actually uses location, so we need to include it --&gt;
    &lt;AsyncLogger name="com.foo.Bar" level="trace" includeLocation="true"&gt;
      &lt;AppenderRef ref="RandomAccessFile"/&gt;
    &lt;/AsyncLogger&gt;
    &lt;Root level="info" includeLocation="true"&gt;
      &lt;AppenderRef ref="RandomAccessFile"/&gt;
    &lt;/Root&gt;
  &lt;/Loggers&gt;
&lt;/Configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a few system properties you can use to control aspects of the asynchronous logging subsystem.
Some of these can be used to tune logging performance.</p>
</div>
<div class="paragraph">
<p>The below properties can also be specified by creating a file named
<code>log4j2.component.properties</code> and including this file in the classpath of the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-properties"><a class="anchor" href="#configuration-properties"></a>Configuration properties</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="log4j.async.logger.configExceptionHandler"><a class="anchor" href="#log4j.async.logger.configExceptionHandler"></a><code>log4j.async.logger.configExceptionHandler</code></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Env. variable</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4J_ASYNC_LOGGER_CONFIG_EXCEPTION_HANDLER</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../javadoc/log4j-async-logger/org/apache/logging/log4j/async/logger/AsyncLoggerConfigExceptionHandler.html"><code>Class&lt; ? extends AsyncLoggerConfigExceptionHandler&gt;</code></a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../javadoc/log4j-async-logger/org/apache/logging/log4j/async/logger/internal/AsyncLoggerConfigDefaultExceptionHandler.html">AsyncLoggerConfigDefaultExceptionHandler</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Fully qualified name of a class that implements the
<a href="../javadoc/log4j-async-logger/org/apache/logging/log4j/async/logger/AsyncLoggerConfigExceptionHandler.html"><code>AsyncLoggerConfigExceptionHandler</code></a>
interface, which will be notified when an exception occurs while logging messages.
The class needs to have a public zero-argument constructor.</p>
</div>
<div class="paragraph">
<p>The default exception handler will print a message and stack trace to the standard error output stream.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This configuration property is used, when Log4j uses a mix of sync and async loggers.</p>
</div>
<div class="paragraph">
<p>See <a href="#MixedSync-Async">Mixing synchronous and asynchronous Loggers</a> for more details.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="log4j.async.logger.exceptionHandler"><a class="anchor" href="#log4j.async.logger.exceptionHandler"></a><code>log4j.async.logger.exceptionHandler</code></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Env. variable</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4J_ASYNC_LOGGER_EXCEPTION_HANDLER</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../javadoc/log4j-async-logger/org/apache/logging/log4j/async/logger/AsyncLoggerExceptionHandler.html"><code>Class&lt; ? extends AsyncLoggerExceptionHandler&gt;</code></a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../javadoc/log4j-async-logger/org/apache/logging/log4j/async/logger/internal/AsyncLoggerDefaultExceptionHandler.html">AsyncLoggerDefaultExceptionHandler</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Fully qualified name of a class that implements the
<a href="../javadoc/log4j-async-logger/org/apache/logging/log4j/async/logger/AsyncLoggerExceptionHandler.html"><code>AsyncLoggerExceptionHandler</code></a>
interface, which will be notified when an exception occurs while logging messages.
The class needs to have a public zero-argument constructor.</p>
</div>
<div class="paragraph">
<p>The default exception handler will print a message and stack trace to the standard error output stream.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This configuration property is used, when Log4j uses exclusively asynchronous loggers.</p>
</div>
<div class="paragraph">
<p>See <a href="#AllAsync">Making all loggers asynchronous</a> for more details.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="log4j.async.logger.synchronizeEnqueueWhenQueueFull"><a class="anchor" href="#log4j.async.logger.synchronizeEnqueueWhenQueueFull"></a><code>log4j.async.logger.synchronizeEnqueueWhenQueueFull</code></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Env. variable</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4J_ASYNC_LOGGER_SYNCHRONIZE_ENQUEUE_WHEN_QUEUE_FULL</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Synchronizes access to the Disruptor ring buffer for blocking enqueue operations when the queue is full.
Users encountered excessive CPU utilization with Disruptor v3.4.2 when the application was logging more than the underlying appender could keep up with and the ring buffer became full, especially when the number of application threads vastly outnumbered the number of cores.
CPU utilization is significantly reduced by restricting access to the enqueue operation.
Setting this value to <code>false</code> may lead to very high CPU utilization when the async logging queue is full.</p>
</div>
</div>
<div class="sect2">
<h3 id="log4j.async.logger.ringBuffer.size"><a class="anchor" href="#log4j.async.logger.ringBuffer.size"></a><code>log4j.async.logger.ringBuffer.size</code></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Env. variable</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4J_ASYNC_LOGGER_RING_BUFFER_SIZE</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>256 &times; 1024</code></p>
<p class="tableblock">(GC-free mode: <code>4 &times; 1024</code>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Size (number of slots) in the RingBuffer used by the asynchronous logging subsystem.
Make this value large enough to deal with bursts of activity.
The minimum size is 128.
The RingBuffer will be pre-allocated at first use and will never grow or shrink during the life of the system.</p>
</div>
<div class="paragraph">
<p>When the application is logging faster than the underlying appender can keep up with for a long enough time to fill up the queue, the behaviour is determined by the <a href="../javadoc/log4j-core/org/apache/logging/log4j/core/async/AsyncQueueFullPolicy.html">AsyncQueueFullPolicy</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="log4j.async.logger.waitStrategy.type"><a class="anchor" href="#log4j.async.logger.waitStrategy.type"></a><code>log4j.async.logger.waitStrategy.type</code></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Env. variable</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4J_ASYNC_LOGGER_WAIT_STRATEGY_TYPE</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">predefined constant</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Timeout</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Specifies the <a href="https://lmax-exchange.github.io/disruptor/javadoc/com.lmax.disruptor/com/lmax/disruptor/WaitStrategy.html">WaitStrategy</a> used by the LMAX Disruptor.</p>
</div>
<div class="paragraph">
<p>The value needs to be one of the predefined constants:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Block</dt>
<dd>
<p>a strategy that uses a lock and condition variable for the I/O thread waiting for log events.
Block can be used when throughput and low-latency are not as important as CPU resource.
Recommended for resource constrained/virtualised environments.</p>
</dd>
<dt class="hdlist1">Timeout</dt>
<dd>
<p>a variation of the <code>Block</code> strategy that will periodically wake up from the lock condition <code>await()</code> call.
This ensures that if a notification is missed somehow the consumer thread is not stuck but will recover with a small latency delay (see <a href="#log4j.async.logger.waitStrategy.timeout"><code>log4j.async.logger.waitStrategy.timeout</code></a>)</p>
</dd>
<dt class="hdlist1">Sleep</dt>
<dd>
<p>a strategy that initially spins, then uses a <code>Thread.yield()</code>, and eventually parks for the minimum number of nanos the OS and JVM will allow while the I/O thread is waiting for log events (see <a href="#log4j.async.logger.waitStrategy.retries"><code>log4j.async.logger.waitStrategy.retries</code></a> and <a href="#log4j.async.logger.waitStrategy.sleepTimeNs"><code>log4j.async.logger.waitStrategy.sleepTimeNs</code></a>).
Sleep is a good compromise between performance and CPU resource.
This strategy has very low impact on the application thread, in exchange for some additional latency for actually getting the message logged.</p>
</dd>
<dt class="hdlist1">Yield</dt>
<dd>
<p>is a strategy that will use <code>100%</code> CPU, but will give up the CPU if other threads require CPU resources.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="log4j.async.logger.waitStrategy.retries"><a class="anchor" href="#log4j.async.logger.waitStrategy.retries"></a><code>log4j.async.logger.waitStrategy.retries</code></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Env. variable</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4J_ASYNC_LOGGER_WAIT_STRATEGY_RETRIES</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>200</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Total number of spin cycles and <code>Thread.yield()</code> cycles of <code>Sleep</code> (see <a href="#log4j.async.logger.waitStrategy.type"><code>log4j.async.logger.waitStrategy.type</code></a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="log4j.async.logger.waitStrategy.sleepTimeNs"><a class="anchor" href="#log4j.async.logger.waitStrategy.sleepTimeNs"></a><code>log4j.async.logger.waitStrategy.sleepTimeNs</code></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Env. variable</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4J_ASYNC_LOGGER_WAIT_STRATEGY_SLEEP_TIME_NS</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>100</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sleep time in nanoseconds of <code>Sleep</code> wait strategy (see <a href="#log4j.async.logger.waitStrategy.type"><code>log4j.async.logger.waitStrategy.type</code></a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="log4j.async.logger.waitStrategy.timeout"><a class="anchor" href="#log4j.async.logger.waitStrategy.timeout"></a><code>log4j.async.logger.waitStrategy.timeout</code></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Env. variable</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4J_ASYNC_LOGGER_WAIT_STRATEGY_TIMEOUT</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Timeout in milliseconds of <code>Timeout</code> wait strategy (see <a href="#log4j.async.logger.waitStrategy.type"><code>log4j.async.logger.waitStrategy.type</code></a>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="WaitStrategy"><a class="anchor" href="#WaitStrategy"></a>Custom WaitStrategy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The system properties mentioned above allow only choice from among a fixed set of predefined WaitStrategies.
There may be cases where you want to configure a custom WaitStrategy that is not in this list.
This is possible by using a <code>AsyncWaitStrategyFactory</code> element in the Log4j configuration.</p>
</div>
<div class="paragraph">
<p>A configuration that configures a custom WaitStrategy can look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration status="WARN"&gt;

  &lt;AsyncWaitStrategyFactory
      class="my.custom.AsyncWaitStrategyFactory" /&gt;

  &lt;Appenders&gt;
    &lt;File name="MyFile" fileName="logs/app.log"&gt;
      &lt;PatternLayout pattern="%d %p %c{1.} [%t] %m%n" /&gt;
    &lt;/File&gt;
  &lt;/Appenders&gt;
  &lt;Loggers&gt;
    &lt;AsyncRoot level="info"&gt;
      &lt;AppenderRef ref="MyFile"/&gt;
    &lt;/AsyncRoot&gt;
  &lt;/Loggers&gt;
&lt;/Configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The specified class must implement the
<code>org.apache.logging.log4j.core.async.AsyncWaitStrategyFactory</code> interface, which is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface AsyncWaitStrategyFactory {
  /**
  * Returns a non-null implementation of the LMAX Disruptor's WaitStrategy interface.
  * This WaitStrategy will be used by Log4j Async Loggers and Async LoggerConfigs.
  *
  * @return the WaitStrategy instance to be used by Async Loggers and Async LoggerConfigs
  */
  WaitStrategy createWaitStrategy();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The specified class must also have a public no-argument constructor; Log4j will instantiate an instance of the specified factory class and use this factory to create the WaitStrategy used by all Async Loggers.</p>
</div>
<div class="paragraph">
<p>WaitStrategy-related system properties are ignored if a <code>AsyncWaitStrategyFactory</code> is configured.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Location"><a class="anchor" href="#Location"></a>Location, location, location&#8230;&#8203;</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If one of the layouts is configured with a location-related attribute like HTML <a href="layouts.html#HtmlLocationInfo" class="xref page">locationInfo</a>, or one of the patterns <a href="layouts.html#PatternClass" class="xref page">%C or $class</a>,
<a href="layouts.html#PatternFile" class="xref page">%F or %file</a>,
<a href="layouts.html#PatternLocation" class="xref page">%l or %location</a>,
<a href="layouts.html#PatternLine" class="xref page">%L or %line</a>,
<a href="layouts.html#PatternMethod" class="xref page">%M or %method</a>, Log4j will take a snapshot of the stack, and walk the stack trace to find the location information.</p>
</div>
<div class="paragraph">
<p>This is an expensive operation: 1.3 - 5 times slower for synchronous loggers.
Synchronous loggers wait as long as possible before they take this stack snapshot.
If no location is required, the snapshot will never be taken.</p>
</div>
<div class="paragraph">
<p>However, asynchronous loggers need to make this decision before passing the log message to another thread; the location information will be lost after that point.
The performance impact of taking a stack trace snapshot is even higher for asynchronous loggers:
logging with location is 30-100 times slower than without location.
For this reason, asynchronous loggers and asynchronous appenders do not include location information by default.</p>
</div>
<div class="paragraph">
<p>You can override the default behaviour in your logger or asynchronous appender configuration by specifying <code>includeLocation="true"</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="UnderTheHood"><a class="anchor" href="#UnderTheHood"></a>Under The Hood</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Asynchronous Loggers are implemented using the
<a href="https://lmax-exchange.github.io/disruptor/">LMAX Disruptor</a> inter-thread messaging library.
From the LMAX web site:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&#8230;&#8203;using queues to pass data between stages of the system was
introducing latency, so we focused on optimising this area.
The Disruptor is the result of our research and testing.
We found that cache misses at the CPU-level, and locks requiring kernel arbitration are both extremely costly, so we created a framework which has "mechanical sympathy" for the hardware it&#8217;s running on, and that&#8217;s lock-free.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>LMAX Disruptor internal performance comparisons with
<code>java.util.concurrent.ArrayBlockingQueue</code> can be found
<a href="https://github.com/LMAX-Exchange/disruptor/wiki/Performance-Results">here</a>.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>
    Copyright © 1999-2024 <a href="https://www.apache.org/">The Apache Software Foundation</a>.
    Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache Software License, Version 2.0</a>.
    Please read our <a href="https://privacy.apache.org/policies/privacy-policy-public.html">privacy policy</a>.
  </p>
  <p>
    Apache, Log4j, and the Apache feather logo are trademarks or registered trademarks of The Apache Software Foundation.
    Oracle and Java are registered trademarks of Oracle and/or its affiliates.
    Other names may be trademarks of their respective owners.
  </p>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<!-- `@asciidoctor/tabs` extension scripts -->
<script async src="../_/js/vendor/tabs.js"></script>
  </body>
</html>
